.PHONY: build run test test-all docker-up docker-down db-up db-down clean

# ========== –†–ê–ó–†–ê–ë–û–¢–ö–ê ==========
build:
	@echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	go build -o bin/pr_service main.go

run: build
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	./bin/pr_service

run-docker: docker-up
	@echo "üê≥ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ Docker –Ω–∞ http://localhost:8080"

# ========== DOCKER (–û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï) ==========
docker-up:
	@echo "üê≥ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ë–î –≤ Docker..."
	docker-compose up -d
	@echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞..."
	@sleep 5
	@echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ http://localhost:8080"

docker-down:
	@echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
	docker-compose down

docker-logs:
	docker-compose logs -f app

# ========== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ==========
test-unit:
	@echo "üß™ –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤..."
	go test ./internal/api ./internal/storage -v

test-e2e: db-up
	@echo "üöÄ –ó–∞–ø—É—Å–∫ E2E —Ç–µ—Å—Ç–æ–≤..."
	go test ./internal/e2e -v -timeout 5m

test-all: test-unit test-e2e

# ========== –¢–ï–°–¢–û–í–ê–Ø –ë–î ==========
db-up:
	@echo "üêò –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î..."
	docker-compose -f docker-compose.test.yml up -d
	@echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î..."
	@until docker-compose -f docker-compose.test.yml exec -T postgres-test pg_isready -U pguser; do \
		sleep 1; \
	done
	@echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ë–î –≥–æ—Ç–æ–≤–∞ –Ω–∞ localhost:5433"

db-down:
	@echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î..."
	docker-compose -f docker-compose.test.yml down

db-logs:
	docker-compose -f docker-compose.test.yml logs -f

# ========== –£–¢–ò–õ–ò–¢–´ ==========
clean: docker-down db-down
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -rf bin/
	docker system prune -f

migrate:
	@echo "üóÉÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
	@go run main.go --migrate || echo "üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: make run"

status:
	@echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
	@echo "–û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:"
	@-docker-compose ps
	@echo ""
	@echo "–¢–µ—Å—Ç–æ–≤–∞—è –ë–î:"
	@-docker-compose -f docker-compose.test.yml ps

help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make run          - –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ"
	@echo "  make run-docker   - –ó–∞–ø—É—Å–∫ –≤ Docker"
	@echo "  make test-unit    - Unit —Ç–µ—Å—Ç—ã"
	@echo "  make test-e2e     - E2E —Ç–µ—Å—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –ë–î)"
	@echo "  make db-up        - –ü–æ–¥–Ω—è—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î"
	@echo "  make db-down      - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î"
	@echo "  make docker-up    - –ü–æ–¥–Ω—è—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + –ë–î"
	@echo "  make docker-down  - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
	@echo "  make status       - –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
